generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  password      String?
  // role          String    @default("USER") // REMOVED in favor of RBAC
  createdAt     DateTime  @default(now())
  tokenVersion  Int       @default(0)
  isSuspended   Boolean   @default(false)

  // Security & RBAC
  roleId        String?
  role          Role?     @relation(fields: [roleId], references: [id])
  permissions   String?   // JSON list of direct permissions (optional override)

  memberProfile MemberProfile?
  feedback      Feedback[]
  auditLogs     AuditLog[]    @relation("AdminAudit")
  storeStaff    StoreStaff[]
}

// ... (Existing models)

model Role {
  id          String       @id @default(cuid())
  name        String       @unique // "Super Admin", "Support", "Finance"
  description String?
  permissions Permission[]
  users       User[]
  
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model Permission {
  id          String   @id @default(cuid())
  action      String   @unique // "user.create", "report.view"
  description String?
  roles       Role[]
  
  groupBy     String   @default("General") // For UI grouping
}

model IpList {
  id        String   @id @default(cuid())
  ip        String   @unique
  type      String   @default("DENY") // ALLOW, DENY
  reason    String?
  isActive  Boolean  @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SecurityEvent {
  id        String   @id @default(cuid())
  userId    String?
  ipAddress String?
  userAgent String?
  action    String   // LOGIN_FAIL, UNAUTHORIZED_ACCESS, SUSPICIOUS_ACTIVITY
  details   String?  @db.Text
  
  createdAt DateTime @default(now())
}

model AuditLog {
  id        String   @id @default(cuid())
  adminId   String
  admin     User     @relation("AdminAudit", fields: [adminId], references: [id])
  targetId  String?  // ID of user/resource affected
  action    String   // POINT_ADJUST, TIER_FORCE, SUSPEND, MERGE
  details   String?  @db.Text
  
  // Enhanced Tracking
  ipAddress String?
  userAgent String?
  
  createdAt DateTime @default(now())
}

model MemberProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  phone       String?
  dateOfBirth DateTime?
  joinDate    DateTime  @default(now())

  pointsBalance Int     @default(0)
  currentTierId String?
  tier          Tier?   @relation(fields: [currentTierId], references: [id])

  // Wallet Extension
  pendingPoints    Int       @default(0)
  expiredPoints    Int       @default(0)
  pointsExpiryDate DateTime?

  // Gamification
  currentStreak Int       @default(0)
  lastVisitDate DateTime?

  // Phase 4: Multi-Wallet
  cashbackBalance Float @default(0.0)
  prepaidBalance  Float @default(0.0)

  transactions   LoyaltyTransaction[]
  redemptions    Redemption[]
  userBadges     UserBadge[]
  userChallenges UserChallenge[]
  supportTickets SupportTicket[]
  notifications  Notification[]

  optInMarketing Boolean @default(false)

  referralCode String?         @unique
  referredById String?
  referrer     MemberProfile?  @relation("Referrals", fields: [referredById], references: [id])
  referrals    MemberProfile[] @relation("Referrals")

  createdAt DateTime @default(now())

  // Analytics Feature
  rfmScore  Int      @default(0)
  clvValue  Float    @default(0.0)
  segment   String   @default("NEW") // NEW, VIP, AT_RISK, CHURNED
  updatedAt DateTime @updatedAt
}

model CommunicationLog {
  id              String        @id @default(cuid())
  campaignId      String?
  campaign        Campaign?     @relation(fields: [campaignId], references: [id])
  
  recipientUserId String?       // If registered user
  recipientContact String       // Email or Phone
  channel         String        // EMAIL, SMS, PUSH
  status          String        // SENT, DELIVERED, FAILED, OPENED, CLICKED
  
  // Phase 7: Tracking
  openedAt        DateTime?
  clickedAt       DateTime?
  templateId      String?
  
  sentAt          DateTime      @default(now())
}

model LoyaltyTransaction {
  id              String        @id @default(cuid())
  memberProfileId String
  memberProfile   MemberProfile @relation(fields: [memberProfileId], references: [id])

  type        String // EARN, REDEEM, ADJUSTMENT
  points      Int // Positive for earn, negative for redeem
  description String?
  amount      Float? // Monetary value if purchase

  // Order Tracking
  orderId      String?
  cashbackUsed Float   @default(0.0)
  source       String? // POS, ONLINE, MANUAL
  
  // Phase 6: POS Integration
  storeId      String?
  store        Store?  @relation(fields: [storeId], references: [id])
  isOfflineSync Boolean @default(false)

  createdAt DateTime @default(now())
}

model Store {
  id          String   @id @default(cuid())
  name        String
  address     String
  city        String
  postalCode  String
  
  latitude    Float
  longitude   Float
  
  phone       String?
  email       String?
  openingHours String? // Text description e.g. "Mon-Fri: 9am-9pm"
  
  imageUrl    String?
  
  isActive    Boolean  @default(true)
  code        String?  @unique // POS Store Code
  
  // Phase 6: POS Monitoring
  lastSyncAt  DateTime?
  posStatus   String    @default("OFFLINE") // OFFLINE, ONLINE, MAINTENANCE

  transactions LoyaltyTransaction[]
  redemptions  Redemption[]
  staff        StoreStaff[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Reward {
  id          String  @id @default(cuid())
  name        String
  description String?
  pointsCost  Int
  costPrice   Float   @default(0.0) // Business cost
  imageUrl    String?
  category    String  @default("OTHER") // Food, Merch, Voucher
  type        String  @default("DIGITAL") // DIGITAL, PHYSICAL
  terms       String? @db.Text
  isActive    Boolean @default(true)

  // Phase 4: Enhanced Controls
  inventory    Int?      // Null = Unlimited
  limitPerUser Int?      // Null = Unlimited
  startDate    DateTime?
  endDate      DateTime?
  
  // Voucher Settings
  autoApprove   Boolean @default(true)
  voucherPrefix String? // e.g., "GIFT-"

  redemptions Redemption[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Redemption {
  id              String        @id @default(cuid())
  memberProfileId String
  memberProfile   MemberProfile @relation(fields: [memberProfileId], references: [id])
  rewardId        String
  reward          Reward        @relation(fields: [rewardId], references: [id])

  status String @default("PENDING") // PENDING, APPROVED, FULFILLED, REJECTED, CANCELLED

  // Phase 4: Voucher Lifecycle
  code      String?   @unique // Voucher Code
  expiresAt DateTime?
  usedAt    DateTime?

  // Approval Workflow
  approvedBy String?
  approvedAt DateTime?

  // Gifting
  isGift             Boolean @default(false)
  giftRecipientEmail String?

  // Phase 8: Store Tracking
  storeId String?
  store   Store?  @relation(fields: [storeId], references: [id])

  redeemedAt DateTime @default(now())
}

model Segment {
  id       String @id @default(cuid())
  name     String
  criteria String // JSON string: { "minPoints": 1000, "daysInactive": 30 ... }

  campaigns Campaign[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Campaign {
  id      String  @id @default(cuid())
  name    String
  subject String?
  content String? // HTML content or Template ID
  type    String // EMAIL, SMS
  status  String  @default("DRAFT") // DRAFT, SCHEDULED, SENT

  // Phase 5: Automation & Segmentation
  scheduledAt DateTime?
  segmentId   String?
  segment     Segment?  @relation(fields: [segmentId], references: [id])

  // A/B Testing
  parentId    String? // If set, this is a variant of parentId
  variantName String? // "A", "B", "Control"

  sentAt    DateTime?

  communicationLogs CommunicationLog[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model MessageTemplate {
  id        String   @id @default(cuid())
  name      String
  type      String   // EMAIL, SMS
  subject   String?  // For Email
  content   String   @db.Text
  variables String?  // JSON list e.g. ["name", "points"]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model StoreStaff {
  id        String   @id @default(cuid())
  storeId   String
  store     Store    @relation(fields: [storeId], references: [id])
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  role      String   @default("CASHIER") // MANAGER, CASHIER
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([storeId, userId])
}

model Tier {
  id        String  @id @default(cuid())
  name      String  @unique // e.g., Silver, Gold
  threshold Int // Points required
  benefits  String? @db.Text

  members MemberProfile[]

  promotions Promotion[] // Exclusive promotions for this tier

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Promotion {
  id          String  @id @default(cuid())
  title       String
  description String? @db.Text
  imageUrl    String?
  type        String  @default("DISCOUNT") // DISCOUNT, COUPON, BIRTHDAY, EVENT

  code          String? // Optional coupon code
  discountValue String? // e.g., "20% OFF", "$10"

  startDate DateTime?
  endDate   DateTime?

  minTierId String?
  minTier   Tier?   @relation(fields: [minTierId], references: [id])

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ProgramSetting {
  id          String  @id @default(cuid())
  settingKey  String  @unique // e.g., "earn_rate", "currency_symbol", "expiry_type" (ROLLING/FIXED), "expiry_days"
  value       String // e.g., "1.5", "$", "FIXED", "365"
  description String?
}

model LoyaltyRule {
  id          String   @id @default(cuid())
  name        String
  description String?
  type        String   @default("SPEND") // SPEND, VISIT, PRODUCT, BIRTHDAY, SIGNUP, ANNIVERSARY
  
  // Rule Logic
  multiplier  Float    @default(1.0) // For SPEND: Points per Currency Unit
  bonusPoints Int      @default(0)   // For EVENTS: Fixed points
  
  minSpend    Float?   // Minimum spend to trigger
  productId   String?  // Specific product trigger
  
  startDate   DateTime?
  endDate     DateTime?
  
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Feedback {
  id     String  @id @default(cuid())
  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  category String // Service, App, Product, Other
  message  String @db.Text
  rating   Int // 1-5

  createdAt DateTime @default(now())
}

model Badge {
  id          String  @id @default(cuid())
  name        String  @unique
  description String?
  icon        String? // Emoji or URL

  userBadges UserBadge[]
}

model UserBadge {
  id              String        @id @default(cuid())
  memberProfileId String
  memberProfile   MemberProfile @relation(fields: [memberProfileId], references: [id])
  badgeId         String
  badge           Badge         @relation(fields: [badgeId], references: [id])

  awardedAt DateTime @default(now())

  @@unique([memberProfileId, badgeId]) // Cannot have duplicate badges of same type
}



model Challenge {
  id           String    @id @default(cuid())
  title        String
  description  String
  goal         Int // Target to reach (e.g. 200 points)
  type         String // SPEND, VISIT, EARN
  pointsReward Int
  startDate    DateTime?
  endDate      DateTime?

  userChallenges UserChallenge[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model UserChallenge {
  id              String        @id @default(cuid())
  memberProfileId String
  memberProfile   MemberProfile @relation(fields: [memberProfileId], references: [id])
  challengeId     String
  challenge       Challenge     @relation(fields: [challengeId], references: [id])

  progress    Int       @default(0)
  status      String    @default("ACTIVE") // ACTIVE, COMPLETED
  completedAt DateTime?

  @@unique([memberProfileId, challengeId])
}

model SupportTicket {
  id              String        @id @default(cuid())
  memberProfileId String
  memberProfile   MemberProfile @relation(fields: [memberProfileId], references: [id])
  subject         String
  status          String        @default("OPEN") // OPEN, IN_PROGRESS, CLOSED
  priority        String        @default("NORMAL") // LOW, NORMAL, HIGH

  messages TicketMessage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TicketMessage {
  id       String        @id @default(cuid())
  ticketId String
  ticket   SupportTicket @relation(fields: [ticketId], references: [id])
  sender   String // USER, SUPPORT
  message  String        @db.Text

  createdAt DateTime @default(now())
}

model FAQ {
  id       String @id @default(cuid())
  question String
  answer   String @db.Text
  category String // General, Account, Rewards
  order    Int    @default(0)

  isActive Boolean @default(true)
}

model ApiKey {
  id           String   @id @default(cuid())
  key          String   @unique
  name         String
  permissions  String?  // JSON or comma-separated list
  rateLimitWaiver Boolean @default(false)
  isActive     Boolean  @default(true)
  lastIp       String?
  
  createdAt    DateTime @default(now())
  lastUsedAt   DateTime?
  
  logs         IntegrationLog[]
}

model WebhookEndpoint {
  id        String   @id @default(cuid())
  url       String
  secret    String?
  events    String   // JSON list of events
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
}

model IntegrationLog {
  id           String   @id @default(cuid())
  endpoint     String
  method       String
  status       Int
  latency      Int      // in ms
  apiKeyId     String?
  apiKey       ApiKey?  @relation(fields: [apiKeyId], references: [id])
  errorDetails String?  @db.Text
  createdAt    DateTime @default(now())
}

model PosTerminal {
  id          String   @id @default(cuid())
  terminalId  String   @unique // External ID from POS system
  storeId     String
  store       Store    @relation(fields: [storeId], references: [id])
  status      String   @default("OFFLINE") // ONLINE, OFFLINE
  lastSyncAt  DateTime?
  createdAt   DateTime @default(now())
}

model Notification {
  id              String        @id @default(cuid())
  memberProfileId String
  memberProfile   MemberProfile @relation(fields: [memberProfileId], references: [id])
  type            String // EARN, REDEEM, SYSTEM, PROMOTION
  title           String
  message         String        @db.Text
  isRead          Boolean       @default(false)
  createdAt       DateTime      @default(now())
}


